---
title: "Albemarle County Equity Profile"
output:
  html_document:
    theme: spacelab
    toc: true
    toc_float: true
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo=FALSE, warning=FALSE, message=FALSE)
```

```{r libdata}
library(tidyverse)
library(RColorBrewer)
library(plotly)
library(reactable)
library(scales)
library("ggspatial")
library(ggnewscale)

# Load combined data
load("webstory_data.RData")

```
## Introduction

Albemarle County’s stated mission is to enhance the well-being and quality of life for all community members through the provision of the highest level of public service consistent with the prudent use of public funds.

This Equity Profile analyzes various conditions across demographic groups and geographic areas that contribute to well-being. The Profile also contextualizes the data from this snapshot in time within the history of the County.

## Demographic History of Albemarle County

Albemarle County’s population has witnessed significant demographic shifts with regard to race/ethnicity over time, as Figure 1 shows. Changing demographics indicate fluctuating conditions of equity for particular populations. Prior to European settlement, Native Americans inhabited Central Virginia for over 10,000 years and Monacan people have inhabited the area for at least 1,000 years. Population statistics tracked by the U.S. government do not capture these facts, contributing to the systemic erasure of Native peoples.

```{r fig1}
race_dec <- race_dec %>% 
  filter(year != 2019)

race_dec_long <- race_dec %>% 
  select(-c(white_per, nonwhite_per)) %>% 
  pivot_longer(-c(year, total_wcc, total_se), names_to = "poptype", values_to = "pop") %>% 
  mutate(pop_percent = round((pop/total_se)*100,1),
         poptype = fct_recode(poptype, 
                              "White Population" = "white_se",
                              "Population of Color" = "nonwhite_se"))

dec_pal <- brewer.pal(5, "BuPu")[c(2,5)]

p <- ggplot(race_dec_long, aes(x = year, y = pop_percent, color = poptype)) +
  geom_line(size = 1) +
  scale_y_continuous(limits = c(0,100)) +
  scale_x_continuous(breaks = seq(1790,2010,10)) +
  scale_color_manual(values = dec_pal) +
  theme_classic() +
  labs(x="Year", y="Population %", title = "", color = "",
       caption = "Figure 1. White Population and Populations of Color in Albemarle County") +
  theme(
    plot.title = element_text(face = "bold", hjust = .5),
    legend.position = "top",
    panel.grid.major.y = element_line(linetype = "dashed", size = .4),
    axis.text.x = element_text(angle = 45, vjust = 0.5))
#p
ggplotly(p)
```

African Americans (free and enslaved) constituted the majority of Albemarle’s population during the dominance of chattel slavery prior to the American Civil War and into the 1800s. Black men and women established separate rural communities throughout the County, such as Proffitt. However, with the introduction of railroads, a Jim Crow-era segregationist government, and continued inequity, many African-American residents in Albemarle County migrated away from the region. 

Since that time, Albemarle’s population has been majority white. However, during the last two decades, the County has been growing more diverse. As of 2019, nearly a quarter of Albemarle’s community members are people of color (Figure 2). African-American people constitute the largest minority group, comprising nearly half of the non-white population and nine percent of the overall population. Among census-defined racial categories, Asian people make up 29 percent of the non-white population (five percent of the overall population), while multiracial residents make up another 17 percent of the populations of color (3 percent overall). Latinx and Hispanic people, not shown in Figure 2, as Hispanic ethnicity may intersect with each of the racial categories captured by the census, constitute six percent of the overall Albemarle population in 2019.

```{r fig2}
race_trends_poc <-
  alb_dems %>%
  filter(category == "RACE" & final_level != "White")

race_trends_poc$final_level <- factor(race_trends_poc$final_level, 
  levels = rev(c("Black or African American", "Asian", 
                 "American Indian and Alaska Native", 
                 "Native Hawaiian and Other Pacific Islander",
                 "Two or more races",
                 "Some other race"))
)

race_trends_poc <-
  race_trends_poc %>%
  select(-category) %>%
  gather(year, pct, -final_level) %>%
  mutate(year = as.numeric(year)) %>%
  ungroup() %>%
  group_by(year) %>%
  arrange(year, desc(final_level)) %>%
  mutate(pct2 = round(100*(pct/sum(pct)),1)) %>%
  mutate(height = cumsum(pct2) - pct2/2) %>%
  mutate(display = ifelse(pct2 > 2, paste0(round(pct2),"%"), ""))

midyear = ceiling((max(race_trends_poc$year) - min(race_trends_poc$year) + 1)/2)

poc_pal <- sample(brewer.pal(7, "BuPu")[-1], 6, replace = FALSE)

race_trends2 <- ggplot(race_trends_poc, aes(x = year, y = pct2, fill = final_level, group = final_level)) +
  geom_area(alpha=0.6 , size=.5, colour = "white") +
  
  # 2019 label
  geom_text(data = race_trends_poc %>%
              # filter(AccesStatus == "Covered without PA") %>%
              group_by(final_level) %>%
              arrange(desc(year)) %>%
              slice(1),
            aes(x = year, label = display, y = height ), color = "Black", alpha = 1.2, hjust = 1, size = 2) +
  
  # 2011 Label
  geom_text(data = race_trends_poc %>%
              # filter(AccesStatus == "Covered without PA") %>%
              group_by(final_level) %>%
              arrange(year) %>%
              slice(1),
            aes(x = year, label = display, y = height ), color = "Black", alpha = 1, hjust = -.2, size = 2) +
  
  # middle label
  geom_text(data = race_trends_poc %>%
              # filter(AccesStatus == "Covered without PA") %>%
              group_by( final_level) %>%
              arrange(year) %>%
              slice(midyear),
            aes(x = year, label = display, y = height ), color = "Black", alpha = 1, hjust = -.2, size = 2) +
  
  scale_y_continuous(labels = function(x) paste0(round(x), "%"), expand = c(0, 0), limits = c(0, 101), breaks=seq(0,100, 25)) +
  scale_x_continuous( breaks=seq(2010,2019, 1), limits = c(2010, 2019))  +
  scale_fill_manual(values =c(rev(poc_pal))) +
  coord_cartesian(clip = 'off') +
  labs(x="Year", y="Population %", fill = "Demographic",
       caption = "Figure 2. Breakdown of Albemarle County Non-White Population, 2019")  +
  theme_bw()+
  theme(
    plot.title = element_text( face="bold", hjust = 0, size = 12),
    legend.title = element_blank(),
    legend.position = "bottom",
    axis.title.x = element_text(face = "bold", vjust=-4.5, size = 10),
    axis.title.y = element_text(face = "bold", size = 10),
    axis.text.x=element_text(vjust=-5),
    axis.ticks.x = element_blank(),
    axis.ticks.y = element_blank(),
    axis.line =  element_line(color  = "white"),
    panel.spacing = unit(1.5, "lines"),
    strip.background = element_blank(),
    strip.text = element_text(face="bold", size = 10),
    panel.border = element_blank(),
    plot.margin=unit(c(t = .25, r = 1, b = 1.5, l = .1),"cm")
  )
race_trends2
#ggplotly(race_trends2)
```

## The Human Development Index

The Human Development Index (HDI) is a metric that assesses the distribution of well-being and equity along three axes: health, access to knowledge, and living standards. As an alternative to money metrics like GDP (Gross Domestic Product), the HDI measures basic indicators of human well-being, going beyond simply measuring income or economic growth. 

In addition to illuminating facets of well-being that cannot be measured through economic metrics, the HDI is a cross-cutting index that reflects the interconnectedness of many different sectors: health, education, housing, and more. Human well-being is influenced by a multiplicity of factors that cannot be isolated from one another, and the HDI captures many of these factors at once. Further, instead of simply offering more data on ongoing problems (i.e., poverty, health issues), the HDI focuses on measuring the impact of ongoing efforts to resolve these problems. By looking at the full spectrum of people in our community, the HDI also promotes an inclusive view in which all of us can see ourselves. This unique approach moves away from prior methods that focus primarily on those living in poverty, which may inadvertently reinforce an us-and-them outlook.

This report employs an adapted version of the HDI, the American Human Development Index (AHDI), which was created by Measure of America of the Social Science Research Council to be estimable at sub-national geographic levels such as states and counties, as well as among population sub-groups by demographics, including race and gender. The AHDI utilizes the same components of the HDI — health, access to knowledge, and living standards — but adapts them to a local American context, increasing their relevance within the conditions of an affluent democracy.

## AHDI in Albemarle County

In terms of scoring, the AHDI scores each component of the measure – health, access to knowledge, and living standards – on a 0-10 scale and then averages those components to produce a single composite score for each geography.

As Table 1 shows, Albemarle County rates quite highly compared to the Commonwealth of Virginia, the whole of the United States, and to surrounding localities that serve as comparative benchmarks. The County’s score of 7.42 on the AHDI suggests that, on average, residents of Albemarle County experience a better quality of life than residents in nearly all of the relevant benchmark geographies.

```{r tab1}
# Columns
hlth_cols <- "life_exp"
ed_cols <- c("hs_grad", "bac_deg", "grad_deg", "school_enroll")
inc_cols <- "pers_earn"
ahdi_sub <- ahdi_table[, c("county", "ahdi", hlth_cols, ed_cols, inc_cols)]

ahdi_sub <- ahdi_sub %>% mutate(county = recode(county, 
                                                "Charlottesville City" = "Charlottesville"))

# Palette
bupu <- c("#edf8fb", "#b3cde3", "#8c96c6", "#8856a7") # bupu (1-4/4)
hlth_colors <- c("#fff5f0", "#fc9272") # colorbrewer Reds 1,4/9
educ_colors <- c("#fee6ce", "#f16913") # colorbrewer Oranges 2,6/9
inc_colors <- c("#e5f5e0", "#238b45") # colorbrewer Greens 2,7/9

ahdi_pal <- function(x) rgb(colorRamp(bupu)(x), maxColorValue = 255) 
hlth_pal <- function(x) rgb(colorRamp(hlth_colors)(x), maxColorValue = 255) 
educ_pal <- function(x) rgb(colorRamp(educ_colors)(x), maxColorValue = 255) 
earn_pal <- function(x) rgb(colorRamp(inc_colors)(x), maxColorValue = 255) 

ahdi_table_output <-
  reactable(ahdi_sub, 
            columns = list(
              county = colDef(name = ""),
              ahdi = colDef(name = "American HDI", align = "center",
                            style = function(value) {
                              normalized <- (value - min(ahdi_sub$ahdi)) / (max(ahdi_sub$ahdi) - min(ahdi_sub$ahdi))
                              color <- ahdi_pal(normalized)
                              list(background = color)
                            },
                            format = colFormat(digits = 2)),
              life_exp = colDef(name = "Life Expectancy at Birth", align = "center",
                                style = function(value) {
                                  normalized <- (value - min(ahdi_sub$life_exp)) / (max(ahdi_sub$life_exp) - min(ahdi_sub$life_exp))
                                  color <- hlth_pal(normalized)
                                  list(background = color)
                                },
                                format = colFormat(digits = 1)),
              hs_grad = colDef(name = "HS Degree or more (Adults 25+)", align = "center",
                               style = function(value) {
                                 normalized <- (value - min(ahdi_sub$hs_grad)) / (max(ahdi_sub$hs_grad) - min(ahdi_sub$hs_grad))
                                 color <- educ_pal(normalized)
                                 list(background = color)
                               },
                               format = colFormat(digits = 1, suffix = "%")),
              bac_deg = colDef(name = "Bachelors Degree or more (Adults 25+)", align = "center",
                               style = function(value) {
                                 normalized <- (value - min(ahdi_sub$bac_deg)) / (max(ahdi_sub$bac_deg) - min(ahdi_sub$bac_deg))
                                 color <- educ_pal(normalized)
                                 list(background = color)
                               },
                               format = colFormat(digits = 1, suffix = "%")),
              grad_deg = colDef(name = "Grad/ Professional Degree (Adults 25+)", align = "center",
                                style = function(value) {
                                  normalized <- (value - min(ahdi_sub$grad_deg)) / (max(ahdi_sub$grad_deg) - min(ahdi_sub$grad_deg))
                                  color <- educ_pal(normalized)
                                  list(background = color)
                                },
                                format = colFormat(digits = 1, suffix = "%")),
              school_enroll = colDef(name = "School Enrollment (Ages 3-24)", align = "center",
                                     style = function(value) {
                                       normalized <- (value - min(ahdi_sub$school_enroll)) / (max(ahdi_sub$school_enroll) - min(ahdi_sub$school_enroll))
                                       color <- educ_pal(normalized)
                                       list(background = color)
                                     },
                                     format = colFormat(digits = 1, suffix = "%")),
              pers_earn = colDef(name = "Median Personal Earnings (Ages 16+)", align = "center",
                                 style = function(value) {
                                   normalized <- (value - min(ahdi_sub$pers_earn)) / (max(ahdi_sub$pers_earn) - min(ahdi_sub$pers_earn))
                                   color <- earn_pal(normalized)
                                   list(background = color)
                                 },
                                 format = colFormat(digits = 0, separators = TRUE, prefix = "$"))
            ),
            columnGroups = list(
              colGroup(name = "Health", columns = hlth_cols),
              colGroup(name = "Access to Knowledge", columns = ed_cols),
              colGroup(name = "Living Standards", columns = inc_cols)
            ),
            highlight = TRUE
  )
ahdi_table_output
```

However, when calculating AHDI scores by census tract, a proxy for neighborhood, we find quite large disparities in overall scores across the county. For example, the tract containing Oak Hill and Southwood has an AHDI score below 5, while tracts containing North Garden and Ivy Garden score near the top of the index scale with scores above 9. The discrepancies in scores between neighborhoods suggests distinct differences in residents’ connections to resources that expand choices, opportunities, and access across the County.

```{r fig5_6}
ahdi_map <-
  alb_tract %>%
  left_join(tract_ahdi %>% mutate(GEOID = as.character(geoid)))

ahdi_map_gg <-
  ggplot(ahdi_map) +
  geom_sf( aes(fill = ahdi), color = "black", alpha = .9) +
  scale_fill_fermenter(limits = c(3,10), palette = "BuPu", direction = 1,   type = "seq", n.breaks = 8) +
  
  theme_void() +
  guides(fill =
           guide_colourbar(title.position="top", title.hjust = 0.5,
                           barwidth = 20)
  ) +
  
  labs(fill = "American Human Development Index",
       caption = "Figure 3. Composite AHDI by Census Tracts in Albemarle County") +
  annotation_scale(location = "br", width_hint = 0.25) +
  annotation_north_arrow(location = "br",
                         which_north = "true",
                         pad_x = unit(0.0, "in"),
                         pad_y = unit(0.5, "in"),
                         style = north_arrow_minimal(
                           line_width = 1,
                           line_col = "black",
                           fill = "black",
                           text_col = "black",
                           text_family = "",
                           text_face = NULL,
                           text_size = 0
                         )) +
  theme(
    legend.position = "top",
    #   legend.box="horizontal",
    legend.title = element_text(),
    panel.border = element_rect(color  = "black",
                                fill = NA,
                                size = 1),
    plot.margin = margin(l =  .1, r = .1, t = 1, b =1, "cm")
    
  )
ahdi_map_gg

tract_ahdi_graph_prep <-
  tract_ahdi %>%
  select(geoid, ahdi_health, ahdi_ed, ahdi_income, ahdi, keypoints) %>%
  gather(component, metric, -c(geoid, keypoints)) %>%
  separate(component, c(NA, "category")) %>%
  mutate(
    category =
      case_when(
        is.na(category) ~ "Composite",
        category == "ed" ~ "Education",
        TRUE ~ str_to_sentence(category)
      ),
    
    category =
      factor(category,
             levels = c(
               "Health",
               "Education",
               "Income",
               "Composite"
             )
      )
  ) %>%
  filter(!is.na(metric)) %>%
  filter(!grepl("UVA", keypoints))

tract_ahdi_graph <-
  tract_ahdi_graph_prep %>%
  mutate(alpha_indicator =
           case_when(
             category == "Composite" ~ 1,
             TRUE ~ 0
           )
  )

# color palette
composite_pal <- c(
  hlth_colors[2],
  educ_colors[2],
  inc_colors[2],
  bupu[4]
)

# county line labeller
ahdi_alb <- ahdi_table[ahdi_table$county == "Albemarle", c("ahdi_ed", "ahdi_income", "ahdi_health", "ahdi")]
names(ahdi_alb) <- c("Education", "Income", "Health", "Composite")

# plot
ggplot(tract_ahdi_graph) +
  geom_point(
    aes(x = metric,
        y = reorder(keypoints, metric),
        color = category
    ),
  )  +
  scale_color_manual(values = composite_pal) +
  scale_alpha_continuous(range = c(0, .7)) +
  scale_size_continuous(range = c(2,4)) +
  scale_x_continuous( limits = c(3, 10.5), breaks = c(seq(3, 10, 1), 0)) +
  scale_y_discrete(labels = function(x) str_wrap(x, width = 20)) +
  
  geom_vline(xintercept = ahdi_alb[1,"Composite"][[1]],
             # linetype = "dashed",
             color = "black",
             size = .2) +
  annotate("text", x = ahdi_alb[1,"Composite"][[1]], y = 19.5,
           label = paste0( "Albemarle County ", "Composite", " AHDI" ),
           vjust = -.7,
           hjust = 0.5,
           color = "black",
           size = 3.5 ) +
  guides(
    alpha = FALSE,
    size = FALSE,
    color = guide_legend(label.position  = "top")
  ) +
  labs(color = "", x = "AHDI", y = "", 
       #title = "Tract-Level American Human Development Index", 
       caption = "Figure 4. AHDI and Components by Census Tracts in Albemarle County") +
  coord_cartesian(clip = "off") +
  theme_classic() +
  theme(
    plot.title = element_text(face = "bold", hjust = .5),
    legend.position = "top",
    panel.grid.major.x = element_blank(),
    panel.grid.minor.x = element_blank(),
    panel.grid.major.y = element_line(linetype = "dashed"),
    axis.line.x = element_line(),
    axis.ticks.x = element_line()
  )

## not quite right -- colors are off, and composite needs to be bigger...
```

## Health: Life Expectancy

The primary health-related measure in the AHDI is life expectancy at birth, that is, the average number of years a baby born today is expected to live given current mortality patterns.

The most recent data available in the County Health Rankings Report estimate Albemarle County’s average life expectancy to be 83 years of age. However, there are major demographic and geographic disparities in life expectancy across Albemarle County (Figure 8). Black residents in the County have a substantially lower life expectancy at birth (77.8 years) compared to White residents (83.4 years). While the life expectancy for Hispanic and Asian community members looks quite high, the much smaller populations on which these estimates are based mean we are less certain about these values. Thus, Figure 8 provides not just the life expectancies, but the range of possible values suggested by the available data. The differences between Black residents and each of the other racially disaggregated groups, however, are stark. Put simply, Black residents can expect to live 5.6 fewer years than their White neighbors.

```{r fig8, echo = FALSE}

life_pal <- hlth_pal( seq(0, 1, length = 5))

life_exp_graph  <-
  ggplot(life_expectancies) +
  
  geom_segment(
    aes(xend = low, x = high, y = reorder(demographic, mean), yend = demographic),
    size = 3,
    color = life_pal[5],
    alpha = .7
  ) +
  
  geom_segment(
    aes(xend = mean - .05,
        x = mean + .05,
        yend = demographic, 
        y = demographic,
    ),
    size = 4
  )  +
  
  geom_text(aes(x = mean , y = demographic, label =  round(mean, 1) ),
            hjust = .5, vjust = -1) +
  
  scale_x_continuous( limits = c(62, 103), breaks = seq(65, 100, 5) ) +
  scale_y_discrete(labels = function(x) str_wrap(x, width = 20)) +
  
  geom_vline(xintercept = 83) +
  
  labs( x = "Average Life Expectancy", y = "", title = "Albemarle County Life Expectancy") +
  coord_cartesian(clip = "off") +
  theme_classic() +
  theme(
    plot.title = element_text(hjust = .5, vjust = 6, face = "bold"),
    legend.position = "none",
    panel.grid.major.x = element_blank(),
    panel.grid.minor.x = element_blank(),
    # axis.title = element_blank(),
    panel.grid.major.y = element_line(linetype = "dashed"),
    #   axis.text.x = element_blank(),
    axis.line.x = element_line(),
    axis.ticks.x = element_line(),
    plot.margin = margin(l = .5, r = 1, t = 2, b =1, "cm"),
    panel.spacing = unit(1, "lines"),
    strip.background = element_blank(),
    strip.placement = "outside",
    strip.text.y = element_text(face = "bold"),
    strip.text.x = element_text(face = "bold")
    
  ) +
  
  facet_grid(demo ~ . ,  switch = "y", scales = "free",  space = "free_y")


life_exp_graph



```
Geographically, we can also see that not every area in the County experiences a similarly high life expectancy (Figure 9). There is a maximum disparity of 11.6 years across neighborhoods 
between North Garden, which enjoys the longest life expectancy, and the Oak Hill/Old Lynchburg Road area, which experiences the shortest. Additionally, the map reveals lower life expectancy rates in the urban ring along the edge of the Charlottesville city limits and in some of the rural areas of Albemarle County in particular. The available data illustrates a clear pattern of disparate health outcomes by race and place (location) in Albemarle County.

```{r fig9}
life_map <-
  alb_tract %>%
  left_join(life_exp %>% mutate(GEOID = as.character(geoid)))

hlth_colors2 <- c("#f0dbe2", "#b02c58")

life_exp_map_gg <-
  ggplot(life_map) +
  geom_sf( aes(fill = life_exp), color = "black", alpha = .9) +
  scale_fill_steps(
    low = hlth_colors2[1],
    high = hlth_colors2[2],
    space = "Lab",
    na.value = "grey50",
    guide = "coloursteps",
    aesthetics = "fill",
    n.breaks = 8
  ) +
  
  theme_void() +
  guides(fill =
           guide_colourbar(title.position="top", title.hjust = 0.5,
                           barwidth = 20)
  ) +
  
  labs(fill = "Life Expectancy",
       caption = "Figure 6. Life Expectancy at Birth by Census Tracts in Albemarle County") +
  annotation_scale(location = "br", width_hint = 0.25) +
  annotation_north_arrow(location = "br",
                         which_north = "true",
                         pad_x = unit(0.0, "in"),
                         pad_y = unit(0.5, "in"),
                         style = north_arrow_minimal(
                           line_width = 1,
                           line_col = "black",
                           fill = "black",
                           text_col = "black",
                           text_family = "",
                           text_face = NULL,
                           text_size = 0
                         )) +
  theme(
    legend.position = "top",
    #   legend.box="horizontal",
    legend.title = element_text(),
    panel.border = element_rect(color  = "black",
                                fill = NA,
                                size = 1),
    plot.margin = margin(l =  .1, r = .1, t = 1, b =1, "cm")
    
  )

life_exp_map_gg
```

## Access to Knowledge: Degree Attainment

Degree attainment for those community members over 25 years of age is a key part of the measure of the Access to Knowledge dimension in the AHDI. Residents of Albemarle County have relatively high levels of formal education. About 3 in 5 adults have a bachelor’s degree, while fewer than 1 in 20 residents do not have a high school diploma.

Access to education is not distributed equally, however. Figure X reveals significant variation in educational attainment by race and ethnicity across the County. The figure is centered around bachelor degree attainment, to make comparisons of this key educational level readily visible. Only 19 percent of Black residents age 25 or more, about 1 in 5, and 32 percent of Hispanic or Latinx residents age 25 or more, about 1 in 3, have bachelor’s degrees, compared to 58 percent of White residents. At the same time, 16 percent of Black residents and nearly a quarter of Hispanic residents do not have a high school diploma, compared to fewer than 7 percent of White residents. These figures suggest current systems of public and higher education are disproportionately failing students of color, and these educational failures have institutional roots in the racialized legacies of American schools.

```{r fig13}
ed_graph <-
  ed_dist %>%
  ungroup() %>%
  group_by(Sex, Race) %>%
  arrange(Sex, Race, desc(degree)) %>%
  mutate(
    end_pct = cumsum(percent),
    start_pct = cumsum(percent) - percent,
    bac_pct = case_when(
      degree == "Some college or associate's degree" ~ end_pct,
      TRUE ~ 0
    ),
    bac_pct = sum(bac_pct),
    start_line = start_pct - bac_pct,
    end_line = start_line + percent,
    height = (start_line + end_line) / 2,
    display =
      case_when(
        percent > 10 ~ paste0(round(percent), "%"),
        TRUE ~ ""
      )
  ) #%>%
# filter(Sex == "All")

educ_colors <- c("#e7dbbc", "#e68026")
ed_ramp <- colour_ramp(educ_colors)
ed_race_pal <- rev(ed_ramp(seq(0, 1, length = 4)))

ed_race <-
  ggplot(ed_graph, aes(y = Race))  +
  geom_segment(aes(x = start_line, xend = end_line, color = degree, yend = Race ),
               size = 14, alpha= .7) +
  scale_color_manual(values = ed_race_pal,
                     name = element_blank(),
                     guide = guide_legend(reverse = TRUE, nrow = 1)) +
  new_scale_color() +
  geom_text(
    aes(x = height, label = display, y = Race, color = degree),  alpha = 1, hjust =   .5, size = 2.75
  ) +
  scale_color_manual(values = c("Black",  "Black", "Black", "Black"),
                     guide = "none") +
  
  geom_segment(aes(x = start_line - .3, xend = start_line, yend = Race ), color = "white",
               size = 14, alpha= 1)  +
  
  geom_vline(xintercept = 0) +
  
  coord_cartesian(clip = 'off') +
  
  scale_x_continuous(
    labels = function(x)
      paste0(abs(round(x)), "%")
  ) +
  
  scale_y_discrete(labels = function(x) str_wrap(x, width = 20)
  ) +
  
  facet_grid(~Sex, scales = "free") +
  
  guides(
    #  color = guide_legend(label.position  = "top")
  ) +
  
  labs(x = "Percentage", y = "", 
       # title = "Educational Distributions by Race and Ethnicity",
       caption = "Figure 7. Degree Attainmenet by Race/Ethnicity in Albemarle County") +
  # guides(color = guide_legend(label.position = "bottom")) +
  theme_classic() +
  theme(panel.spacing = unit(.5, "lines"),
        strip.background = element_blank(),
        strip.placement = "outside",
        strip.text.y = element_text(face = "bold"),
        strip.text.x = element_text(face = "bold"),
        #   axis.text.x = element_blank(),
        #  axis.ticks.x = element_blank(),
        #  axis.text.y=element_text(face= c("plain", "plain", "plain", "plain", "plain", "plain", "bold")),
        legend.position = "bottom",
        plot.title = element_text(hjust = .5, face = "bold")
  )
ed_race
```


Geographically, we also see disparities in rates of attainment of bachelor’s degrees (Figure 14). Rates of bachelor degree attainment range from a high of 79 percent in Ivy to a low of 28 percent in Southern Albemarle, a more than 50 percentage point difference. The COVID-19 pandemic and the need to school from home further amplifies the impact of this disparate geographic distribution of educational attainment. As access to common school resources is reduced, children’s differential access to home and neighborhood-based networks of support has greater influence. Despite the generally strong levels of educational attainment among Albemarle County residents, steps can be taken to promote educational attainment for all adults, especially given the multiple high-quality higher educational institutions in the area.

```{r fig14}
ed_map <-
  ggplot(ed_geo_tract) +
  geom_sf( aes(fill = perc_bac), color = "black") +
  scale_fill_steps(
    low = educ_colors[1],
    high = educ_colors[2],
    space = "Lab",
    na.value = "grey50",
    guide = "coloursteps",
    aesthetics = "fill",
    n.breaks = 10,
    labels = percent
    
  ) +
  theme_void() +
  guides(fill =
           guide_colourbar(title.position="top", title.hjust = 0.5,
                           barwidth = 20)
  ) +
  labs(fill = "Percent With Bachelor's Degree or Higher",
       caption = "Figure 8. Bachelor’s Degrees by Census Tracts in Albemarle County") +
  annotation_scale(location = "br", width_hint = 0.25) +
  annotation_north_arrow(location = "br",
                         which_north = "true",
                         pad_x = unit(0.0, "in"),
                         pad_y = unit(0.5, "in"),
                         style = north_arrow_minimal(
                           line_width = 1,
                           line_col = "black",
                           fill = "black",
                           text_col = "black",
                           text_family = "",
                           text_face = NULL,
                           text_size = 0
                         )) +
  theme(
    legend.position = "top",
    legend.title = element_text(),
    panel.border = element_rect(color  = "black",
                                fill = NA,
                                size = 1),
    plot.margin = margin(l =  .1, r = .1, t = 1, b =1, "cm")
    
  )
ed_map
```

## Living Standards: Household Income and Cost of Living

Personal earnings and household income are closely tied to well-being and quality of life. Median personal earnings in Albemarle County stand at \$44,030, a level higher than the Commonwealth of Virginia or the whole of the US, and a relatively high level compared with benchmark localities nearby. For this reason, the County scores relatively highly on the AHDI. The median household income in Albemarle County in 2019 is similarly high, at \$86,399. However, there are concentrations of higher and lower income households distributed across areas in the County. Median household income by census tract ranges from a low of \$41,000, less than half of that for the County overall, to a high of \$135,100.

```{r fig18}
inc_colors <- c("#b1c5be", "#106449")

med_hhinc_map  <-
  ggplot(med_hhinc_tract_map) +
  geom_sf( aes(fill = estimate), color = "black", alpha = .9) +
  scale_fill_steps(
    low = inc_colors[1],
    high = inc_colors[2],
    space = "Lab",
    na.value = "grey50",
    guide = "coloursteps",
    aesthetics = "fill",
    n.breaks = 8,
    labels = dollar_format(prefix = "$", suffix = "", 
                           big.mark = ",", 
    )
    
  ) +
  
  theme_void() +
  guides(fill =
           guide_colourbar(title.position="top", title.hjust = 0.5,
                           barwidth = 20)
  ) +
  
  labs(fill = "Median Household Income",
       caption = "Figure 9. Median Household Income by Census Tracts in Albemarle County") +
  annotation_scale(location = "br", width_hint = 0.25) +
  annotation_north_arrow(location = "br",
                         which_north = "true",
                         pad_x = unit(0.0, "in"),
                         pad_y = unit(0.5, "in"),
                         style = north_arrow_minimal(
                           line_width = 1,
                           line_col = "black",
                           fill = "black",
                           text_col = "black",
                           text_family = "",
                           text_face = NULL,
                           text_size = 0
                         )) +
  theme(
    legend.position = "top",
    legend.text = element_text(angle = -45, hjust = 0),
    legend.title = element_text(),
    panel.border = element_rect(color  = "black",
                                fill = NA,
                                size = 1),
    plot.margin = margin(l =  .1, r = .1, t = 1, b =1, "cm")
    
  )
med_hhinc_map
```

Additional context is necessary to better understand how household incomes compare with the cost of living within Albemarle County. A useful measure for whether household incomes are sufficient to meet the costs of living is the United Way’s Asset Limited, Income Constrained, Employed (ALICE) threshold. The ALICE threshold is calibrated to the cost of living in each county. The Household Survival Budget that defines the threshold is a conservative dollar estimation of the minimum 12-month costs for a household to live in a particular area. It considers the costs of housing, healthcare, food, transportation, technology, taxes, childcare (if applicable), and a contingency fund equal to 10 percent of the overall budget.

In 2018, the most recent year with available estimates, the Household Survival Budget in Albemarle County was about \$75,000, meaning those with household incomes above \$75,000 exceeded the ALICE threshold. Over two-thirds, 37 percent, of Albemarle County households were ALICE households, unable to meet needs based on local cost of living, and an additional 9 percent were living in poverty. 

```{r fig19}
alice_graph  <-
  alice_alb %>%
  mutate(level = case_when(
    level == "poverty_household" ~ "Poverty",
    level == "alice__household" ~ "ALICE",
    level == "above_alice_household" ~ "Above ALICE")
  ) %>%
  group_by(name) %>%
  arrange(year, desc(level)) %>%
  mutate(height = cumsum(pct) - pct/2) %>%
  mutate(display = ifelse(pct > 2, paste0(round(pct),"%" ), ""),
         display2 = paste0(display, " ", "(", number, ")"))

inc_pal <- function(x) rgb(colorRamp(inc_colors)(x), maxColorValue = 255) 
alice_pal <- inc_pal(seq(0, 1, length = 3))

alice_gg <- 
  ggplot(alice_graph, aes(x = name, y = pct, fill = level, group = level)) +
  geom_col(alpha=0.6) +
  scale_fill_manual(values = alice_pal) +
  geom_text(
    aes(x = name, label = display2, y = height),  
    alpha = 1, hjust =   .5, size = 2.75) +
  # geom_text(
  #   aes(x = name, label = number, y = height-5),  
  #   alpha = 1, hjust =   .5, size = 2.75) +
  labs(x="Magisterial District", y="Percent", fill = "Income Status", 
       #title = "Asset Limited, Income Constrained, Employed Population in Albemarle",
       caption = "Figure 10. ALICE Threshold in Albemarle County by Magisterial District") +
    theme_bw() +
  theme(
    plot.title = element_text(face="bold", hjust = .5, size = 12),
    legend.title = element_blank(),
    legend.position = "top",
    axis.title.x = element_text(face = "bold", vjust=-2.5, size = 10),
    axis.title.y = element_text(face = "bold", size = 10),
    axis.text.x=element_text(),
    axis.ticks.x = element_blank(),
    axis.ticks.y = element_blank(),
    axis.line =  element_line(color  = "white"),
    panel.spacing = unit(1.5, "lines"),
    strip.background = element_blank(),
    strip.text = element_text(face="bold", size = 10),
    panel.border = element_blank()
    #plot.margin=unit(c(t = .25, r = 1, b = 1.5, l = .1),"cm")
  )
alice_gg
```

Figure X shows how households of each race or ethnicity have fared since 2010 in terms of household income relative to cost of living. The graphs show clearly that median incomes among Black, Hispanic, and Native peoples’ households have been well below the ALICE threshold for the last ten years, while more recently the threshold is overtaking the incomes of White and Asian households.

```{r fig21}
alice_thresh_graph <-
  alice_thresh %>%
  filter(!race %in% c("White , Not Hispanic Or Latino")) %>%
  mutate(
    race = factor(race, levels = c(
      "Overall",
      "White",
      "Black Or African American",
      "Asian",
      "American Indian And Alaska Native",
      "Two Or More Races",
      "Some Other Race",
      "Hispanic Or Latino"
    )
    )
  ) %>%
  filter(!is.na(race)) %>% 
  filter(race != "Overall")

alice_thresh_gg <-
  ggplot(alice_thresh_graph, aes(x = year, y = `ALICE Threshold`)) +
  geom_area(data = alice_thresh_graph,
            aes(x = year, y = `ALICE Threshold`),
            color = "black", size = 0, alpha = .1,
            fill = alice_pal[3] ) +
  geom_line(data = alice_thresh_graph %>%
              gather(type, value, -year, -race),
            aes(x = year, y = value, color = type),
            inherit.aes = FALSE, size = 1 ) +
  
  scale_color_manual(values = c("black", "blue")) +
  
  annotate("segment", x=-Inf, xend=Inf, y=-Inf, yend=-Inf, size = 1)+
  
  labs(color = "", y = "", x = "", 
       #title = "Cost of Living Outpaces Median Income",
       caption = "Figure 11. ALICE Threshold in Albemarle County by Race/Ethnicity, 2010-2018") +
  
  scale_y_continuous(limits = c(0, 100000), labels = function(x) paste0("$",formatC(x, format = "d", big.mark = ","))    )+
  theme_classic() +
  theme(
    plot.title = element_text(face = "bold", hjust = .5),
    #  legend.position = c(.85, .15),
    legend.position = "top",
    
    axis.line.y = element_blank(),
    strip.background = element_rect(fill = "light grey"),
    panel.spacing = unit(1, "lines"),
    panel.grid.major.y = element_line(linetype = "dashed", size = .4),
    axis.line.x = element_blank(),
  ) +
  facet_wrap(~race, scales = "free_x")

alice_thresh_gg
```

## Looking Forward

This profile provides an opportunity for County staff and other community members to broaden understanding of how well-being is experienced in Albemarle. Staff continues to build upon that knowledge and to work with increased focus on supporting the organization’s ability to incorporate equity and inclusion into our practices as we endeavor to fulfill our mission of enhancing well-being for all in our community. There is full awareness that our ability to affect that mission is closely tied to our ability to understand how the impacts of our work relate to outcomes in our community, with equity being centered in that consideration. 

Efforts underway include the development and application of a framework for equity impact assessment and a supporting analytical tool (Equity Atlas), as well as staff training in the use of both. The equity impact assessment is a guiding framework intended to aid staff in examining proposed actions or decisions. The Equity Atlas, cocreated in collaboration with the UVA Equity Center, uses digital mapping to visualize indicators related to well-being and existing conditions in Albemarle County. The tool has been developed with accountability, ethical data collection, and equitable decision-making in mind. It is intended to be used as a supportive resource to the equity impact assessment, aiding staff in developing a data-informed understanding of the distribution of outcomes in Albemarle County.

These efforts, while new, reflect a renewed commitment on the part of the County’s local government to deepen and expand its work to ensure the equitable distribution of local government resources and ultimately of well-being in our community. This Profile represents a first iteration of what we expect to become a regular process of assessing community conditions and subsequently measuring our impact in creating positive outcomes for all.
